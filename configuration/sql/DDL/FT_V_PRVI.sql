--------------------------------------------------------------------
-- |----------------------------------------------------------------
-- | Product ID: GSDM
-- | Project: CBA FRTB EDM 
-- | Date: 26-Apr-2018
-- | Requested By: 
-- | Approved By: 
-- | Prepared By: GoldenSource
-- |----------------------------------------------------------------
-- | Tables Affected: 
-- |----------------------------------------------------------------
-- History     :
---------------------------------------------------------------------
-- S.No.  DefectID             Date       By              Description
-- --------------------------------------------------------------------
-- 1.     


SET SCAN OFF;
SET ECHO ON;
SET DEFINE OFF;

--------------------------------------------------------------------
CREATE OR REPLACE VIEW FT_V_PRVI_V2
(
   INSTR_ID,
   PRVI_OID,
   PRC_VALIDATION_TYP,
   PRC_TYP,
   PRC_CURR_CDE,
   PRCNG_METH_TYP,
   PRC_SRCE_TYP,
   MKT_OID,
   VALIDATION_OVERRIDE_IND,
   START_TMS,
   END_TMS,
   VHDF_OID,
   PRC_QT_METH_TYP,
   PRCNG_FQ_SP_TYP,
   PRCNG_FQ_DY_TYP,
   PRCNG_FQ_QTY,
   STALE_PRC_PRD_QTY,
   LAST_CHG_TMS,
   LAST_CHG_USR_ID,
   LOW_RNG_CPRC,
   UP_RNG_CPRC,
   PRC_TOL_LOWER_CPRC,
   PRC_TOL_UPPER_CPRC,
   PRC_TOL_LOWER_CPCT,
   PRC_TOL_UPPER_CPCT,
   DWDF_OID,
   ADDNL_PRC_QUAL_TYP,
   DATA_SRC_ID,
   TOL_RTE_ADJ_INSTR_ID,
   PRIM_TRD_MKT_IND,
   VENDOR_MATCH_CNT,
   COMP_MAX_PRC_AGE_NUM,
   OVR_SUSPECT_STAT_IND,
   CMNT_TXT,
   FX_TYP,
   FX_RTE_VALID_TYP,
   FX_PRC_TYP,
   FX_SRCE_TYP,
   GPRC_DFLT_TO_PRIOR_IND,
   GPRC_PRC_DERIV_IND,
   REL_TYP,
   PRC_VALID_TYP,
   GU_GRP_OID,
   GU_ID,
   GU_TYP,
   GU_CNT,
   GU_PURP_TYP,
   HIGHEST_VOL_IND,
   MULTI_VENDOR_CMPRSN_TXT,
   NO_PREDECESSOR_STAT_TYP,
   GPRC_GT_1_CANDIDATE_IND,
   PRC_VALIDATION_NME,
   PRC_VALIDATION_DESC,
   ADDNL_PRC_VALIDATION_TYP,
   VND_HIER_CON_CMPRSN_IND,
   FX_CROSS_RTE_CURR_CDE,
   DERIVED_PRC_GPRC_IND,
   TOL_COND_IND,
   HIGH_VOL_FIRST_IND,
   GC_OBS_PRD_DY_CNT,
   PPED_OID,
   MULT_PRC_TXT,
   ISPT_OID,
   IPGR_OID,
   PRNT_PRVI_OID,
   PRC_VALIDATION_SQ_NUM,
   ON_VALID_PRVI_OID,
   ON_SUSPECT_PRVI_OID,
   ON_MISSING_PRVI_OID,
   PRC_MKT_CMP_IND,
   MATCH_KEY_VALID_TXT,
   PRC_TOL_UPPER_FORMULA_TXT,
   PRC_TOL_LOWER_FORMULA_TXT,
   PRC_TOL_CLASS_NME,
   PRC_TOL_FORMULA_GPRC_IND,
   GUNT_OID,
   OPERATOR_CDE,
   BUS_DY_CNT,
   MKIS_IND,
   MKT_GRP_OID,
   STALE_OPT_IND,
   VENDOR_CHK_IND
)
AS
   SELECT ISSU.INSTR_ID,
          PRVI.PRVI_OID,
          PRVI.PRC_VALIDATION_TYP,
          PRVI.PRC_TYP,
          PRVI.PRC_VALIDN_CURR_CDE PRC_CURR_CDE,
          PRVI.PRCNG_METH_TYP,
          PRVI.PRC_SRCE_TYP,
          PRVI.MKT_OID,
          PRVI.VALIDATION_OVERRIDE_IND,
          PRVI.START_TMS,
          PRVI.END_TMS,
          PRVI.VHDF_OID,
          PRVI.PRC_QT_METH_TYP,
          PRVI.PRCNG_FQ_SP_TYP,
          PRVI.PRCNG_FQ_DY_TYP,
          PRVI.PRCNG_FQ_QTY,
          PRVI.STALE_PRC_PRD_QTY,
          PRVI.LAST_CHG_TMS,
          PRVI.LAST_CHG_USR_ID,
          PRVI.LOW_RNG_CPRC,
          PRVI.UP_RNG_CPRC,
          PRVI.PRC_TOL_LOWER_CPRC,
          PRVI.PRC_TOL_UPPER_CPRC,
          PRVI.PRC_TOL_LOWER_CPCT,
          PRVI.PRC_TOL_UPPER_CPCT,
          PRVI.DWDF_OID,
          PRVI.ADDNL_PRC_QUAL_TYP,
          PRVI.DATA_SRC_ID,
          PRVI.TOL_RTE_ADJ_INSTR_ID,
          PRVI.PRIM_TRD_MKT_IND,
          PRVI.VENDOR_MATCH_CNT,
          PRVI.COMP_MAX_PRC_AGE_NUM,
          PRVI.OVR_SUSPECT_STAT_IND,
          PRVI.CMNT_TXT,
          PRVI.FX_TYP,
          PRVI.FX_RTE_VALID_TYP,
          PRVI.FX_PRC_TYP,
          PRVI.FX_SRCE_TYP,
          PRVI.GPRC_DFLT_TO_PRIOR_IND,
          PRVI.GPRC_PRC_DERIV_IND,
          PRVI.REL_TYP,
          PRVI.PRC_VALID_TYP,
          PRVI.GU_GRP_OID,
          PRVI.GU_ID,
          PRVI.GU_TYP,
          PRVI.GU_CNT,
          PRVI.GU_PURP_TYP,
          PRVI.HIGHEST_VOL_IND,
          PRVI.MULTI_VENDOR_CMPRSN_TXT,
          PRVI.NO_PREDECESSOR_STAT_TYP,
          PRVI.GPRC_GT_1_CANDIDATE_IND,
          PRVI.PRC_VALIDATION_NME,
          PRVI.PRC_VALIDATION_DESC,
          PRVI.ADDNL_PRC_VALIDATION_TYP,
          PRVI.VND_HIER_CON_CMPRSN_IND,
          PRVI.FX_CROSS_RTE_CURR_CDE,
          PRVI.DERIVED_PRC_GPRC_IND,
          PRVI.TOL_COND_IND,
          PRVI.HIGH_VOL_FIRST_IND,
          PRVI.GC_OBS_PRD_DY_CNT,
          PRVI.PPED_OID,
          PRVI.MULT_PRC_TXT,
          PRVI.ISPT_OID,
          PRVI.IPGR_OID,
          PRVI.PRNT_PRVI_OID,
          PRVI.PRC_VALIDATION_SQ_NUM,
          PRVI.ON_VALID_PRVI_OID,
          PRVI.ON_SUSPECT_PRVI_OID,
          PRVI.ON_MISSING_PRVI_OID,
          PRVI.PRC_MKT_CMP_IND,
          PRVI.MATCH_KEY_VALID_TXT,
          PRVI.PRC_TOL_UPPER_FORMULA_TXT,
          PRVI.PRC_TOL_LOWER_FORMULA_TXT,
          PRVI.PRC_TOL_CLASS_NME,
          PRVI.PRC_TOL_FORMULA_GPRC_IND,
          PRVI.GUNT_OID,
          PRVI.OPERATOR_CDE,
          PRVI.BUS_DY_CNT,
          PRVI.MKIS_IND,
          PRVI.MKT_GRP_OID,
          PRVI.STALE_OPT_IND,
          PRVI.VENDOR_CHK_IND
     FROM FT_T_PRVI PRVI
          JOIN FT_T_ISGR ISGR
             ON PRVI.ISS_GRP_OID = ISGR.ISS_GRP_OID
          JOIN FT_T_ISGP ISGP
             ON ISGR.ISS_GRP_OID = ISGP.PRNT_ISS_GRP_OID
          JOIN FT_T_ISSU ISSU
             ON ISGP.INSTR_ID = ISSU.INSTR_ID
    WHERE     1 = 1
          AND ( (PRVI.INSTR_ID = ISSU.INSTR_ID) OR PRVI.INSTR_ID IS NULL)
          AND ( (PRVI.ISS_TYP = ISSU.ISS_TYP) OR (PRVI.ISS_TYP IS NULL))
   UNION
   -- ONLY INSTR_ID IS SET, ONLY ISS_TYP SET, NOTHING SET
   SELECT ISSU.INSTR_ID,
          PRVI.PRVI_OID,
          PRVI.PRC_VALIDATION_TYP,
          PRVI.PRC_TYP,
          PRVI.PRC_VALIDN_CURR_CDE PRC_CURR_CDE,
          PRVI.PRCNG_METH_TYP,
          PRVI.PRC_SRCE_TYP,
          PRVI.MKT_OID,
          PRVI.VALIDATION_OVERRIDE_IND,
          PRVI.START_TMS,
          PRVI.END_TMS,
          PRVI.VHDF_OID,
          PRVI.PRC_QT_METH_TYP,
          PRVI.PRCNG_FQ_SP_TYP,
          PRVI.PRCNG_FQ_DY_TYP,
          PRVI.PRCNG_FQ_QTY,
          PRVI.STALE_PRC_PRD_QTY,
          PRVI.LAST_CHG_TMS,
          PRVI.LAST_CHG_USR_ID,
          PRVI.LOW_RNG_CPRC,
          PRVI.UP_RNG_CPRC,
          PRVI.PRC_TOL_LOWER_CPRC,
          PRVI.PRC_TOL_UPPER_CPRC,
          PRVI.PRC_TOL_LOWER_CPCT,
          PRVI.PRC_TOL_UPPER_CPCT,
          PRVI.DWDF_OID,
          PRVI.ADDNL_PRC_QUAL_TYP,
          PRVI.DATA_SRC_ID,
          PRVI.TOL_RTE_ADJ_INSTR_ID,
          PRVI.PRIM_TRD_MKT_IND,
          PRVI.VENDOR_MATCH_CNT,
          PRVI.COMP_MAX_PRC_AGE_NUM,
          PRVI.OVR_SUSPECT_STAT_IND,
          PRVI.CMNT_TXT,
          PRVI.FX_TYP,
          PRVI.FX_RTE_VALID_TYP,
          PRVI.FX_PRC_TYP,
          PRVI.FX_SRCE_TYP,
          PRVI.GPRC_DFLT_TO_PRIOR_IND,
          PRVI.GPRC_PRC_DERIV_IND,
          PRVI.REL_TYP,
          PRVI.PRC_VALID_TYP,
          PRVI.GU_GRP_OID,
          PRVI.GU_ID,
          PRVI.GU_TYP,
          PRVI.GU_CNT,
          PRVI.GU_PURP_TYP,
          PRVI.HIGHEST_VOL_IND,
          PRVI.MULTI_VENDOR_CMPRSN_TXT,
          PRVI.NO_PREDECESSOR_STAT_TYP,
          PRVI.GPRC_GT_1_CANDIDATE_IND,
          PRVI.PRC_VALIDATION_NME,
          PRVI.PRC_VALIDATION_DESC,
          PRVI.ADDNL_PRC_VALIDATION_TYP,
          PRVI.VND_HIER_CON_CMPRSN_IND,
          PRVI.FX_CROSS_RTE_CURR_CDE,
          PRVI.DERIVED_PRC_GPRC_IND,
          PRVI.TOL_COND_IND,
          PRVI.HIGH_VOL_FIRST_IND,
          PRVI.GC_OBS_PRD_DY_CNT,
          PRVI.PPED_OID,
          PRVI.MULT_PRC_TXT,
          PRVI.ISPT_OID,
          PRVI.IPGR_OID,
          PRVI.PRNT_PRVI_OID,
          PRVI.PRC_VALIDATION_SQ_NUM,
          PRVI.ON_VALID_PRVI_OID,
          PRVI.ON_SUSPECT_PRVI_OID,
          PRVI.ON_MISSING_PRVI_OID,
          PRVI.PRC_MKT_CMP_IND,
          PRVI.MATCH_KEY_VALID_TXT,
          PRVI.PRC_TOL_UPPER_FORMULA_TXT,
          PRVI.PRC_TOL_LOWER_FORMULA_TXT,
          PRVI.PRC_TOL_CLASS_NME,
          PRVI.PRC_TOL_FORMULA_GPRC_IND,
          PRVI.GUNT_OID,
          PRVI.OPERATOR_CDE,
          PRVI.BUS_DY_CNT,
          PRVI.MKIS_IND,
          PRVI.MKT_GRP_OID,
          PRVI.STALE_OPT_IND,
          PRVI.VENDOR_CHK_IND
     FROM    FT_T_PRVI PRVI
          JOIN
             FT_T_ISSU ISSU
          ON ( ( (PRVI.INSTR_ID = ISSU.INSTR_ID) OR PRVI.INSTR_ID IS NULL)
              AND ( (PRVI.ISS_TYP = ISSU.ISS_TYP) OR (PRVI.ISS_TYP IS NULL)))
    WHERE 1 = 1 AND PRVI.ISS_TYP_GRP_OID IS NULL AND PRVI.ISS_GRP_OID IS NULL;
           